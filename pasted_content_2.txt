#!/usr/bin/env python3
"""
Servidor simples para a Procissão Marítima de Angra dos Reis
Salva dados de usuários em arquivo de texto e gera QR Code PIX fictício
"""

import http.server
import socketserver
import json
import os
from urllib.parse import urlparse, parse_qs
from datetime import datetime

PORT = 8000
ARQUIVO_DADOS = os.path.join(os.path.dirname(__file__), 'dados_usuarios.txt') # Caminho absoluto para o arquivo de dados

class MeuHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        parsed_path = urlparse(self.path)
        query_params = parse_qs(parsed_path.query)

        if parsed_path.path == '/gerar_pix_qrcode':
            self.gerar_pix_qrcode(query_params)
        else:
            # Servir arquivos estáticos
            if self.path == '/':
                self.path = '/index.html'
            super().do_GET()
    
    def do_POST(self):
        # Processar requisições POST para salvar dados
        if self.path == '/salvar_dados.php': 
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length)
            
            try:
                dados = json.loads(body.decode('utf-8'))
                
                # Formatar dados para arquivo
                conteudo = '=' * 80 + '\n'
                conteudo += 'REGISTRO DE COMPRA DE INGRESSO - PROCISSÃO MARÍTIMA DE ANGRA DOS REIS\n'
                conteudo += '=' * 80 + '\n\n'
                
                for chave, valor in dados.items():
                    chave_formatada = chave.replace('_', ' ').title()
                    conteudo += f'{chave_formatada}: {valor}\n'
                
                conteudo += '\n' + '=' * 80 + '\n\n'
                
                # Salvar em arquivo
                with open(ARQUIVO_DADOS, 'a', encoding='utf-8') as f:
                    f.write(conteudo)
                
                # Enviar resposta JSON de sucesso
                self.send_response(200)
                self.send_header('Content-Type', 'application/json')
                self.send_header('Access-Control-Allow-Origin', '*')
                self.end_headers()
                resposta = json.dumps({'sucesso': True, 'mensagem': 'Dados salvos com sucesso'})
                self.wfile.write(resposta.encode('utf-8'))
                
            except Exception as e:
                # Enviar resposta JSON de erro
                self.send_response(500)
                self.send_header('Content-Type', 'application/json')
                self.send_header('Access-Control-Allow-Origin', '*')
                self.end_headers()
                resposta = json.dumps({'sucesso': False, 'mensagem': str(e)})
                self.wfile.write(resposta.encode('utf-8'))
        else:
            # Se não for a rota de salvar dados, tratar como POST normal (ou erro 404)
            self.send_response(404)
            self.end_headers()
    
    def do_OPTIONS(self):
        # Suportar requisições OPTIONS (CORS preflight)
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()

    def gerar_pix_qrcode(self, params):
        """
        Gera um QR Code fictício em SVG para fins de demonstração
        """
        try:
            # SVG do QR Code fictício
            svg_qrcode = '''<svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
            <!-- Fundo branco -->
            <rect width="300" height="300" fill="white"/>
            
            <!-- Padrão fictício de QR Code -->
            <!-- Canto superior esquerdo (padrão de localização) -->
            <rect x="10" y="10" width="70" height="70" fill="none" stroke="black" stroke-width="2"/>
            <rect x="15" y="15" width="60" height="60" fill="black"/>
            <rect x="20" y="20" width="50" height="50" fill="white"/>
            <rect x="25" y="25" width="40" height="40" fill="black"/>
            
            <!-- Canto superior direito (padrão de localização) -->
            <rect x="220" y="10" width="70" height="70" fill="none" stroke="black" stroke-width="2"/>
            <rect x="225" y="15" width="60" height="60" fill="black"/>
            <rect x="230" y="20" width="50" height="50" fill="white"/>
            <rect x="235" y="25" width="40" height="40" fill="black"/>
            
            <!-- Canto inferior esquerdo (padrão de localização) -->
            <rect x="10" y="220" width="70" height="70" fill="none" stroke="black" stroke-width="2"/>
            <rect x="15" y="225" width="60" height="60" fill="black"/>
            <rect x="20" y="230" width="50" height="50" fill="white"/>
            <rect x="25" y="235" width="40" height="40" fill="black"/>
            
            <!-- Padrão de sincronização horizontal -->
            <line x1="90" y1="40" x2="210" y2="40" stroke="black" stroke-width="2"/>
            <line x1="90" y1="45" x2="210" y2="45" stroke="black" stroke-width="2"/>
            
            <!-- Padrão de sincronização vertical -->
            <line x1="40" y1="90" x2="40" y2="210" stroke="black" stroke-width="2"/>
            <line x1="45" y1="90" x2="45" y2="210" stroke="black" stroke-width="2"/>
            
            <!-- Dados fictícios do QR Code (padrão aleatório) -->
            <rect x="100" y="100" width="8" height="8" fill="black"/>
            <rect x="112" y="100" width="8" height="8" fill="black"/>
            <rect x="124" y="100" width="8" height="8" fill="white"/>
            <rect x="136" y="100" width="8" height="8" fill="black"/>
            <rect x="148" y="100" width="8" height="8" fill="black"/>
            <rect x="160" y="100" width="8" height="8" fill="white"/>
            <rect x="172" y="100" width="8" height="8" fill="black"/>
            <rect x="184" y="100" width="8" height="8" fill="black"/>
            <rect x="196" y="100" width="8" height="8" fill="white"/>
            <rect x="208" y="100" width="8" height="8" fill="black"/>
            
            <rect x="100" y="112" width="8" height="8" fill="white"/>
            <rect x="112" y="112" width="8" height="8" fill="black"/>
            <rect x="124" y="112" width="8" height="8" fill="black"/>
            <rect x="136" y="112" width="8" height="8" fill="white"/>
            <rect x="148" y="112" width="8" height="8" fill="black"/>
            <rect x="160" y="112" width="8" height="8" fill="black"/>
            <rect x="172" y="112" width="8" height="8" fill="white"/>
            <rect x="184" y="112" width="8" height="8" fill="black"/>
            <rect x="196" y="112" width="8" height="8" fill="black"/>
            <rect x="208" y="112" width="8" height="8" fill="white"/>
            
            <rect x="100" y="124" width="8" height="8" fill="black"/>
            <rect x="112" y="124" width="8" height="8" fill="white"/>
            <rect x="124" y="124" width="8" height="8" fill="black"/>
            <rect x="136" y="124" width="8" height="8" fill="black"/>
            <rect x="148" y="124" width="8" height="8" fill="white"/>
            <rect x="160" y="124" width="8" height="8" fill="black"/>
            <rect x="172" y="124" width="8" height="8" fill="black"/>
            <rect x="184" y="124" width="8" height="8" fill="white"/>
            <rect x="196" y="124" width="8" height="8" fill="black"/>
            <rect x="208" y="124" width="8" height="8" fill="black"/>
            
            <rect x="100" y="136" width="8" height="8" fill="white"/>
            <rect x="112" y="136" width="8" height="8" fill="black"/>
            <rect x="124" y="136" width="8" height="8" fill="white"/>
            <rect x="136" y="136" width="8" height="8" fill="black"/>
            <rect x="148" y="136" width="8" height="8" fill="black"/>
            <rect x="160" y="136" width="8" height="8" fill="white"/>
            <rect x="172" y="136" width="8" height="8" fill="black"/>
            <rect x="184" y="136" width="8" height="8" fill="black"/>
            <rect x="196" y="136" width="8" height="8" fill="white"/>
            <rect x="208" y="136" width="8" height="8" fill="black"/>
            
            <rect x="100" y="148" width="8" height="8" fill="black"/>
            <rect x="112" y="148" width="8" height="8" fill="black"/>
            <rect x="124" y="148" width="8" height="8" fill="black"/>
            <rect x="136" y="148" width="8" height="8" fill="white"/>
            <rect x="148" y="148" width="8" height="8" fill="black"/>
            <rect x="160" y="148" width="8" height="8" fill="black"/>
            <rect x="172" y="148" width="8" height="8" fill="white"/>
            <rect x="184" y="148" width="8" height="8" fill="black"/>
            <rect x="196" y="148" width="8" height="8" fill="black"/>
            <rect x="208" y="148" width="8" height="8" fill="white"/>
            
            <rect x="100" y="160" width="8" height="8" fill="white"/>
            <rect x="112" y="160" width="8" height="8" fill="white"/>
            <rect x="124" y="160" width="8" height="8" fill="black"/>
            <rect x="136" y="160" width="8" height="8" fill="black"/>
            <rect x="148" y="160" width="8" height="8" fill="white"/>
            <rect x="160" y="160" width="8" height="8" fill="black"/>
            <rect x="172" y="160" width="8" height="8" fill="black"/>
            <rect x="184" y="160" width="8" height="8" fill="white"/>
            <rect x="196" y="160" width="8" height="8" fill="black"/>
            <rect x="208" y="160" width="8" height="8" fill="black"/>
            
            <rect x="100" y="172" width="8" height="8" fill="black"/>
            <rect x="112" y="172" width="8" height="8" fill="black"/>
            <rect x="124" y="172" width="8" height="8" fill="white"/>
            <rect x="136" y="172" width="8" height="8" fill="black"/>
            <rect x="148" y="172" width="8" height="8" fill="black"/>
            <rect x="160" y="172" width="8" height="8" fill="white"/>
            <rect x="172" y="172" width="8" height="8" fill="black"/>
            <rect x="184" y="172" width="8" height="8" fill="black"/>
            <rect x="196" y="172" width="8" height="8" fill="white"/>
            <rect x="208" y="172" width="8" height="8" fill="black"/>
            
            <rect x="100" y="184" width="8" height="8" fill="white"/>
            <rect x="112" y="184" width="8" height="8" fill="black"/>
            <rect x="124" y="184" width="8" height="8" fill="black"/>
            <rect x="136" y="184" width="8" height="8" fill="white"/>
            <rect x="148" y="184" width="8" height="8" fill="black"/>
            <rect x="160" y="184" width="8" height="8" fill="black"/>
            <rect x="172" y="184" width="8" height="8" fill="white"/>
            <rect x="184" y="184" width="8" height="8" fill="black"/>
            <rect x="196" y="184" width="8" height="8" fill="black"/>
            <rect x="208" y="184" width="8" height="8" fill="white"/>
            
            <rect x="100" y="196" width="8" height="8" fill="black"/>
            <rect x="112" y="196" width="8" height="8" fill="white"/>
            <rect x="124" y="196" width="8" height="8" fill="black"/>
            <rect x="136" y="196" width="8" height="8" fill="black"/>
            <rect x="148" y="196" width="8" height="8" fill="white"/>
            <rect x="160" y="196" width="8" height="8" fill="black"/>
            <rect x="172" y="196" width="8" height="8" fill="black"/>
            <rect x="184" y="196" width="8" height="8" fill="white"/>
            <rect x="196" y="196" width="8" height="8" fill="black"/>
            <rect x="208" y="196" width="8" height="8" fill="black"/>
            
            <rect x="100" y="208" width="8" height="8" fill="white"/>
            <rect x="112" y="208" width="8" height="8" fill="black"/>
            <rect x="124" y="208" width="8" height="8" fill="white"/>
            <rect x="136" y="208" width="8" height="8" fill="black"/>
            <rect x="148" y="208" width="8" height="8" fill="black"/>
            <rect x="160" y="208" width="8" height="8" fill="white"/>
            <rect x="172" y="208" width="8" height="8" fill="black"/>
            <rect x="184" y="208" width="8" height="8" fill="black"/>
            <rect x="196" y="208" width="8" height="8" fill="white"/>
            <rect x="208" y="208" width="8" height="8" fill="black"/>
            </svg>'''
            
            self.send_response(200)
            self.send_header('Content-Type', 'image/svg+xml')
            self.send_header('Access-Control-Allow-Origin', '*')
            self.end_headers()
            self.wfile.write(svg_qrcode.encode('utf-8'))

        except Exception as e:
            self.send_response(500)
            self.send_header('Content-Type', 'application/json')
            self.send_header('Access-Control-Allow-Origin', '*')
            self.end_headers()
            resposta = json.dumps({'sucesso': False, 'mensagem': str(e)})
            self.wfile.write(resposta.encode('utf-8'))

if __name__ == '__main__':
    # Mudar o diretório de trabalho para o diretório do script
    os.chdir(os.path.dirname(os.path.abspath(__file__)))
    
    with socketserver.TCPServer(('', PORT), MeuHandler) as httpd:
        print(f'Servidor iniciado em http://localhost:{PORT}')
        print(f'Dados serão salvos em: {os.path.abspath(ARQUIVO_DADOS)}')
        print('Pressione Ctrl+C para parar o servidor')
        try:
            httpd.serve_forever()
        except KeyboardInterrupt:
            print('\nServidor parado.')

